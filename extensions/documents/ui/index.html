<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Documents</title>
    <link rel="stylesheet" href="../../../../static/extensions/ui.css?v=2" />
    <script src="../../../../static/extensions/ext-bridge.js"></script>
    <style>
        html, body.doc-root { height: 100%; margin: 0; padding: 0; }
        .doc-root { display: flex; flex-direction: column; overflow: hidden; }
        .doc-content { flex: 1; min-height: 0; min-width: 0; overflow-y: auto; padding: 1rem 1.5rem; }
        /* Riquadro unificato: cartelle, documenti (icona/thumbnail) stesso stile e dimensioni */
        .doc-icon, .folder-icon, .doc-thumb {
            flex-shrink: 0; border-radius: 0.25rem; border: 1px solid #ddd; background: #f5f5f5;
            width: 2.5rem; height: 2.5rem; min-width: 2.5rem; min-height: 2.5rem;
        }
        .doc-icon, .folder-icon { display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .doc-icon { color: #c00; }
        .folder-icon { color: #f90; }
        .doc-thumb { object-fit: contain; }
        .doc-list-item-doc { display: flex; align-items: center; gap: 0.75rem; }
        .doc-list:not(.doc-grid) .ext-ui-list-item-content { display: flex; flex-direction: row; align-items: center; gap: 0.75rem; min-width: 0; }
        .doc-list:not(.doc-grid) .ext-ui-list-item-name { flex: 1; min-width: 0; }
        .doc-breadcrumb { display: flex; align-items: center; gap: 0.25rem; margin-bottom: 0.75rem; font-size: 0.9rem; flex-wrap: wrap; }
        .doc-breadcrumb span { color: #666; cursor: pointer; }
        .doc-breadcrumb span:hover { color: #333; text-decoration: underline; }
        .doc-breadcrumb .current { color: #333; cursor: default; font-weight: 600; }
        .doc-breadcrumb .current:hover { text-decoration: none; }
        .doc-view-toggle { display: flex; gap: 2px; flex-shrink: 0; }
        .doc-view-toggle .ext-toolbar-btn { flex-shrink: 0; }
        .doc-view-toggle .ext-toolbar-btn.active { background: #e3f2fd; border-color: #2196f3; color: #2196f3; }
        .doc-list { width: 100%; min-width: 0; }
        .doc-list.doc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; }
        .doc-list.doc-grid .ext-ui-list-item { flex-direction: column; align-items: stretch; padding: 0.5rem; overflow: hidden; }
        .doc-list.doc-grid .ext-ui-list-item-content { flex-direction: column; align-items: center; text-align: center; width: 100%; box-sizing: border-box; min-width: 0; overflow: hidden; }
        .doc-list.doc-grid .doc-icon, .doc-list.doc-grid .folder-icon, .doc-list.doc-grid .doc-thumb {
            width: 100%; max-width: 120px; aspect-ratio: 120/165; min-width: 0; min-height: 0; height: auto; margin-bottom: 0.25rem; flex-shrink: 0;
        }
        .doc-list.doc-grid .doc-icon, .doc-list.doc-grid .folder-icon { font-size: 4rem; }
        .doc-list.doc-grid .doc-thumb { object-fit: cover; }
        .doc-list.doc-grid .ext-ui-list-item-name { white-space: normal; word-break: break-word; width: 100%; }
        .doc-list.doc-grid .ext-item-actions { justify-content: center; margin-top: 0.25rem; width: 100%; }
        .doc-rename-input { width: 100%; max-width: 200px; padding: 0.2rem 0.4rem; font-size: 0.9rem; }
        .visibility-btn.on { color: #2196f3; font-weight: bold; }
        .doc-move-select { font-size: 0.85rem; padding: 0.2rem 0.4rem; }
        @media (max-width: 480px) {
            .doc-list.doc-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.4rem; }
            .doc-list.doc-grid .ext-ui-list-item { padding: 0.35rem; }
            .doc-list.doc-grid .doc-icon, .doc-list.doc-grid .folder-icon, .doc-list.doc-grid .doc-thumb {
                max-width: 70px;
            }
            .doc-list.doc-grid .doc-icon, .doc-list.doc-grid .folder-icon { font-size: 2.5rem; }
            .doc-breadcrumb { font-size: 0.85rem; }
        }
        @media (min-width: 769px) {
            .doc-list.doc-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
        }
        @media (min-width: 1200px) {
            .doc-list.doc-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }
        @media (min-width: 481px) and (max-width: 768px) {
            .doc-list.doc-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; }
            .doc-list.doc-grid .doc-icon, .doc-list.doc-grid .folder-icon, .doc-list.doc-grid .doc-thumb {
                max-width: 90px;
            }
            .doc-list.doc-grid .doc-icon, .doc-list.doc-grid .folder-icon { font-size: 3rem; }
        }
    </style>
</head>
<body class="ext-ui-root doc-root">
    <div id="topBar" class="ext-toolbar-bar doc-top-bar" style="display:none">
        <div class="ext-search-bar">
            <span class="ext-search-icon" aria-hidden="true">&#128269;</span>
            <input type="text" id="docSearchInput" class="ext-search-input" placeholder="" />
            <input type="file" id="fileInput" class="ext-ui-file-input" accept=".pdf,application/pdf" multiple />
            <button type="button" id="uploadBtn" class="ext-search-add-btn" title=""></button>
        </div>
        <button type="button" id="newFolderBtn" class="ext-ui-btn"></button>
        <div class="doc-view-toggle">
            <button type="button" id="viewListBtn" title="" class="ext-toolbar-btn active"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button>
            <button type="button" id="viewGridBtn" title="" class="ext-toolbar-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3v8h8V3H3zm6 6H5V5h4v4zm-6 4v8h8v-8H3zm6 6H5v-4h4v4zm4-16v8h8V3h-8zm6 6h-4V5h4v4zm-6 4v8h8v-8h-8zm6 6h-4v-4h4v4z"/></svg></button>
        </div>
    </div>
    <div id="content" class="doc-content">
        <div id="breadcrumb" class="doc-breadcrumb" style="display:none"></div>
        <div id="loading" class="ext-ui-loading"></div>
        <div id="empty" class="ext-ui-empty" style="display:none"></div>
        <ul id="list" class="ext-ui-list doc-list" style="display:none"></ul>
        <div id="msg"></div>
    </div>

    <script>
        (function() {
            var TRANSLATIONS = {
                en: {
                    documents: "Documents",
                    new_folder: "New folder",
                    upload_pdf: "Upload PDF",
                    loading: "Loading...",
                    no_documents: "No documents in this folder.",
                    search_documents: "Search documents...",
                    rename: "Rename",
                    move: "Move",
                    delete: "Delete",
                    delete_confirm: "Delete \"{{name}}\"? This cannot be undone.",
                    new_name: "New name:",
                    renamed: "Renamed.",
                    rename_failed: "Rename failed.",
                    move_to_folder: "Move to folder (enter number):",
                    documents_root: "Documents (root)",
                    moved: "Moved.",
                    move_failed: "Move failed.",
                    error_loading: "Error loading documents.",
                    deleted: "Deleted.",
                    delete_failed: "Delete failed.",
                    folder_name: "Folder name:",
                    folder_created: "Folder created.",
                    failed: "Failed.",
                    document_uploaded: "Document uploaded.",
                    documents_uploaded_count: "documents uploaded",
                    upload_failed: "Upload failed.",
                    view_list: "List view",
                    view_grid: "Grid view",
                    shared_with_me: "Shared with me",
                    visible_to_players: "Visible to players"
                },
                it: {
                    documents: "Documenti",
                    new_folder: "Nuova cartella",
                    upload_pdf: "Carica PDF",
                    loading: "Caricamento...",
                    no_documents: "Nessun documento in questa cartella.",
                    search_documents: "Cerca documenti...",
                    rename: "Rinomina",
                    move: "Sposta",
                    delete: "Elimina",
                    delete_confirm: "Eliminare \"{{name}}\"? Questa azione non pu√≤ essere annullata.",
                    new_name: "Nuovo nome:",
                    renamed: "Rinominato.",
                    rename_failed: "Rinomina fallita.",
                    move_to_folder: "Sposta nella cartella (inserisci numero):",
                    documents_root: "Documenti (radice)",
                    moved: "Spostato.",
                    move_failed: "Spostamento fallito.",
                    error_loading: "Errore nel caricamento dei documenti.",
                    deleted: "Eliminato.",
                    delete_failed: "Eliminazione fallita.",
                    folder_name: "Nome cartella:",
                    folder_created: "Cartella creata.",
                    failed: "Fallito.",
                    document_uploaded: "Documento caricato.",
                    documents_uploaded_count: "documenti caricati",
                    upload_failed: "Caricamento fallito.",
                    view_list: "Vista elenco",
                    view_grid: "Vista griglia",
                    shared_with_me: "Condivisi con me",
                    visible_to_players: "Visibili ai giocatori"
                },
                de: {
                    documents: "Dokumente",
                    new_folder: "Neuer Ordner",
                    upload_pdf: "PDF hochladen",
                    loading: "Laden...",
                    no_documents: "Keine Dokumente in diesem Ordner.",
                    search_documents: "Dokumente suchen...",
                    rename: "Umbenennen",
                    move: "Verschieben",
                    delete: "L√∂schen",
                    delete_confirm: "\"{{name}}\" l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden.",
                    new_name: "Neuer Name:",
                    renamed: "Umbenannt.",
                    rename_failed: "Umbenennen fehlgeschlagen.",
                    move_to_folder: "In Ordner verschieben (Nummer eingeben):",
                    documents_root: "Dokumente (Stamm)",
                    moved: "Verschoben.",
                    move_failed: "Verschieben fehlgeschlagen.",
                    error_loading: "Fehler beim Laden der Dokumente.",
                    deleted: "Gel√∂scht.",
                    delete_failed: "L√∂schen fehlgeschlagen.",
                    folder_name: "Ordnername:",
                    folder_created: "Ordner erstellt.",
                    failed: "Fehlgeschlagen.",
                    document_uploaded: "Dokument hochgeladen.",
                    documents_uploaded_count: "Dokumente hochgeladen",
                    upload_failed: "Hochladen fehlgeschlagen.",
                    view_list: "Listenansicht",
                    view_grid: "Rasteransicht",
                    shared_with_me: "Mit mir geteilt",
                    visible_to_players: "F√ºr Spieler sichtbar"
                },
                dk: {
                    documents: "Dokumenter",
                    new_folder: "Ny mappe",
                    upload_pdf: "Upload PDF",
                    loading: "Indl√¶ser...",
                    no_documents: "Ingen dokumenter i denne mappe.",
                    search_documents: "S√∏g dokumenter...",
                    rename: "Omd√∏b",
                    move: "Flyt",
                    delete: "Slet",
                    delete_confirm: "Slet \"{{name}}\"? Dette kan ikke fortrydes.",
                    new_name: "Nyt navn:",
                    renamed: "Omd√∏bt.",
                    rename_failed: "Omd√∏bning mislykkedes.",
                    move_to_folder: "Flyt til mappe (indtast nummer):",
                    documents_root: "Dokumenter (rod)",
                    moved: "Flyttet.",
                    move_failed: "Flytning mislykkedes.",
                    error_loading: "Fejl ved indl√¶sning af dokumenter.",
                    deleted: "Slettet.",
                    delete_failed: "Sletning mislykkedes.",
                    folder_name: "Mappenavn:",
                    folder_created: "Mappe oprettet.",
                    failed: "Mislykkedes.",
                    document_uploaded: "Dokument uploadet.",
                    documents_uploaded_count: "dokumenter uploadet",
                    upload_failed: "Upload mislykkedes.",
                    view_list: "Listevisning",
                    view_grid: "Gittervisning",
                    shared_with_me: "Delt med mig",
                    visible_to_players: "Synlig for spillere"
                },
                es: {
                    documents: "Documentos",
                    new_folder: "Nueva carpeta",
                    upload_pdf: "Subir PDF",
                    loading: "Cargando...",
                    no_documents: "No hay documentos en esta carpeta.",
                    search_documents: "Buscar documentos...",
                    rename: "Renombrar",
                    move: "Mover",
                    delete: "Eliminar",
                    delete_confirm: "¬øEliminar \"{{name}}\"? Esta acci√≥n no se puede deshacer.",
                    new_name: "Nuevo nombre:",
                    renamed: "Renombrado.",
                    rename_failed: "Error al renombrar.",
                    move_to_folder: "Mover a carpeta (introduce el n√∫mero):",
                    documents_root: "Documentos (ra√≠z)",
                    moved: "Movido.",
                    move_failed: "Error al mover.",
                    error_loading: "Error al cargar documentos.",
                    deleted: "Eliminado.",
                    delete_failed: "Error al eliminar.",
                    folder_name: "Nombre de carpeta:",
                    folder_created: "Carpeta creada.",
                    failed: "Error.",
                    document_uploaded: "Documento subido.",
                    documents_uploaded_count: "documentos subidos",
                    upload_failed: "Error al subir.",
                    view_list: "Vista de lista",
                    view_grid: "Vista de cuadr√≠cula",
                    shared_with_me: "Compartido conmigo",
                    visible_to_players: "Visible para jugadores"
                },
                fr: {
                    documents: "Documents",
                    new_folder: "Nouveau dossier",
                    upload_pdf: "T√©l√©verser PDF",
                    loading: "Chargement...",
                    no_documents: "Aucun document dans ce dossier.",
                    search_documents: "Rechercher des documents...",
                    rename: "Renommer",
                    move: "D√©placer",
                    delete: "Supprimer",
                    delete_confirm: "Supprimer \"{{name}}\" ? Cette action est irr√©versible.",
                    new_name: "Nouveau nom :",
                    renamed: "Renomm√©.",
                    rename_failed: "√âchec du renommage.",
                    move_to_folder: "D√©placer vers le dossier (entrez le num√©ro) :",
                    documents_root: "Documents (racine)",
                    moved: "D√©plac√©.",
                    move_failed: "√âchec du d√©placement.",
                    error_loading: "Erreur lors du chargement des documents.",
                    deleted: "Supprim√©.",
                    delete_failed: "√âchec de la suppression.",
                    folder_name: "Nom du dossier :",
                    folder_created: "Dossier cr√©√©.",
                    failed: "√âchec.",
                    document_uploaded: "Document t√©l√©vers√©.",
                    documents_uploaded_count: "documents t√©l√©vers√©s",
                    upload_failed: "√âchec du t√©l√©versement.",
                    view_list: "Vue liste",
                    view_grid: "Vue grille",
                    shared_with_me: "Partag√© avec moi",
                    visible_to_players: "Visible aux joueurs"
                },
                ru: {
                    documents: "–î–æ–∫—É–º–µ–Ω—Ç—ã",
                    new_folder: "–ù–æ–≤–∞—è –ø–∞–ø–∫–∞",
                    upload_pdf: "–ó–∞–≥—Ä—É–∑–∏—Ç—å PDF",
                    loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                    no_documents: "–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ.",
                    search_documents: "–ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...",
                    rename: "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å",
                    move: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å",
                    delete: "–£–¥–∞–ª–∏—Ç—å",
                    delete_confirm: "–£–¥–∞–ª–∏—Ç—å \"{{name}}\"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.",
                    new_name: "–ù–æ–≤–æ–µ –∏–º—è:",
                    renamed: "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ.",
                    rename_failed: "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è.",
                    move_to_folder: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –ø–∞–ø–∫—É (–≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä):",
                    documents_root: "–î–æ–∫—É–º–µ–Ω—Ç—ã (–∫–æ—Ä–µ–Ω—å)",
                    moved: "–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ.",
                    move_failed: "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è.",
                    error_loading: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.",
                    deleted: "–£–¥–∞–ª–µ–Ω–æ.",
                    delete_failed: "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.",
                    folder_name: "–ò–º—è –ø–∞–ø–∫–∏:",
                    folder_created: "–ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞.",
                    failed: "–û—à–∏–±–∫–∞.",
                    document_uploaded: "–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω.",
                    documents_uploaded_count: "–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ",
                    upload_failed: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.",
                    view_list: "–í–∏–¥ —Å–ø–∏—Å–∫–∞",
                    view_grid: "–í–∏–¥ —Å–µ—Ç–∫–∏",
                    shared_with_me: "–ü–æ–¥–µ–ª–∏–ª–∏—Å—å —Å–æ –º–Ω–æ–π",
                    visible_to_players: "–í–∏–¥–Ω–æ –∏–≥—Ä–æ–∫–∞–º"
                },
                tw: {
                    documents: "Êñá‰ª∂",
                    new_folder: "Êñ∞Â¢ûË≥áÊñôÂ§æ",
                    upload_pdf: "‰∏äÂÇ≥ PDF",
                    loading: "ËºâÂÖ•‰∏≠...",
                    no_documents: "Ê≠§Ë≥áÊñôÂ§æ‰∏≠Ê≤íÊúâÊñá‰ª∂„ÄÇ",
                    search_documents: "ÊêúÂ∞ãÊñá‰ª∂...",
                    rename: "ÈáçÊñ∞ÂëΩÂêç",
                    move: "ÁßªÂãï",
                    delete: "Âà™Èô§",
                    delete_confirm: "Âà™Èô§„Äå{{name}}„ÄçÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ",
                    new_name: "Êñ∞ÂêçÁ®±Ôºö",
                    renamed: "Â∑≤ÈáçÊñ∞ÂëΩÂêç„ÄÇ",
                    rename_failed: "ÈáçÊñ∞ÂëΩÂêçÂ§±Êïó„ÄÇ",
                    move_to_folder: "ÁßªÂãïÂà∞Ë≥áÊñôÂ§æÔºàËº∏ÂÖ•Á∑®ËôüÔºâÔºö",
                    documents_root: "Êñá‰ª∂ÔºàÊ†πÁõÆÈåÑÔºâ",
                    moved: "Â∑≤ÁßªÂãï„ÄÇ",
                    move_failed: "ÁßªÂãïÂ§±Êïó„ÄÇ",
                    error_loading: "ËºâÂÖ•Êñá‰ª∂ÊôÇÁôºÁîüÈåØË™§„ÄÇ",
                    deleted: "Â∑≤Âà™Èô§„ÄÇ",
                    delete_failed: "Âà™Èô§Â§±Êïó„ÄÇ",
                    folder_name: "Ë≥áÊñôÂ§æÂêçÁ®±Ôºö",
                    folder_created: "Ë≥áÊñôÂ§æÂ∑≤Âª∫Á´ã„ÄÇ",
                    failed: "Â§±Êïó„ÄÇ",
                    document_uploaded: "Êñá‰ª∂Â∑≤‰∏äÂÇ≥„ÄÇ",
                    documents_uploaded_count: "ÂÄãÊñá‰ª∂Â∑≤‰∏äÂÇ≥",
                    upload_failed: "‰∏äÂÇ≥Â§±Êïó„ÄÇ",
                    view_list: "Ê∏ÖÂñÆÊ™¢Ë¶ñ",
                    view_grid: "Á∂≤Ê†ºÊ™¢Ë¶ñ",
                    shared_with_me: "ËàáÊàëÂàÜ‰∫´",
                    visible_to_players: "Â∞çÁé©ÂÆ∂ÂèØË¶ã"
                },
                zh: {
                    documents: "ÊñáÊ°£",
                    new_folder: "Êñ∞Âª∫Êñá‰ª∂Â§π",
                    upload_pdf: "‰∏ä‰º† PDF",
                    loading: "Âä†ËΩΩ‰∏≠...",
                    no_documents: "Ê≠§Êñá‰ª∂Â§π‰∏≠Ê≤°ÊúâÊñáÊ°£„ÄÇ",
                    search_documents: "ÊêúÁ¥¢ÊñáÊ°£...",
                    rename: "ÈáçÂëΩÂêç",
                    move: "ÁßªÂä®",
                    delete: "Âà†Èô§",
                    delete_confirm: "Âà†Èô§„Äå{{name}}„ÄçÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ",
                    new_name: "Êñ∞ÂêçÁß∞Ôºö",
                    renamed: "Â∑≤ÈáçÂëΩÂêç„ÄÇ",
                    rename_failed: "ÈáçÂëΩÂêçÂ§±Ë¥•„ÄÇ",
                    move_to_folder: "ÁßªÂä®Âà∞Êñá‰ª∂Â§πÔºàËæìÂÖ•ÁºñÂè∑ÔºâÔºö",
                    documents_root: "ÊñáÊ°£ÔºàÊ†πÁõÆÂΩïÔºâ",
                    moved: "Â∑≤ÁßªÂä®„ÄÇ",
                    move_failed: "ÁßªÂä®Â§±Ë¥•„ÄÇ",
                    error_loading: "Âä†ËΩΩÊñáÊ°£Êó∂Âá∫Èîô„ÄÇ",
                    deleted: "Â∑≤Âà†Èô§„ÄÇ",
                    delete_failed: "Âà†Èô§Â§±Ë¥•„ÄÇ",
                    folder_name: "Êñá‰ª∂Â§πÂêçÁß∞Ôºö",
                    folder_created: "Êñá‰ª∂Â§πÂ∑≤ÂàõÂª∫„ÄÇ",
                    failed: "Â§±Ë¥•„ÄÇ",
                    document_uploaded: "ÊñáÊ°£Â∑≤‰∏ä‰º†„ÄÇ",
                    documents_uploaded_count: "‰∏™ÊñáÊ°£Â∑≤‰∏ä‰º†",
                    upload_failed: "‰∏ä‰º†Â§±Ë¥•„ÄÇ",
                    view_list: "ÂàóË°®ËßÜÂõæ",
                    view_grid: "ÁΩëÊ†ºËßÜÂõæ",
                    shared_with_me: "‰∏éÊàëÂàÜ‰∫´",
                    visible_to_players: "ÂØπÁé©ÂÆ∂ÂèØËßÅ"
                }
            };

            function getLocale() {
                var params = new URLSearchParams(window.location.search);
                var loc = params.get('locale') || 'en';
                return TRANSLATIONS[loc] ? loc : 'en';
            }

            var locale = getLocale();
            var L = TRANSLATIONS[locale] || TRANSLATIONS.en;
            document.documentElement.lang = locale;

            function t(key) {
                return L[key] || TRANSLATIONS.en[key] || key;
            }

            function base() {
                const p = window.location.pathname;
                const i = p.indexOf('/api/');
                return i >= 0 ? p.slice(0, i) : '';
            }
            function api(path) { return base() + path; }

            document.getElementById('newFolderBtn').textContent = t('new_folder');
            document.getElementById('uploadBtn').textContent = '+';
            document.getElementById('uploadBtn').title = t('upload_pdf');
            document.getElementById('docSearchInput').placeholder = t('search_documents');
            document.getElementById('loading').textContent = t('loading');

            const listEl = document.getElementById('list');
            const loadingEl = document.getElementById('loading');
            const emptyEl = document.getElementById('empty');
            const breadcrumbEl = document.getElementById('breadcrumb');
            const topBarEl = document.getElementById('topBar');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const newFolderBtn = document.getElementById('newFolderBtn');
            const docSearchInput = document.getElementById('docSearchInput');
            const msgEl = document.getElementById('msg');

            let rootId = null;
            let currentFolderId = null;
            let items = [];
            let folderPath = [];
            let viewMode = 'list';
            var pencilSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
            var folderSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>';
            var trashSvg = '<svg viewBox="0 0 448 512" fill="currentColor"><path d="M135.2 17.69L128 32H32C14.33 32 0 46.33 0 64v384c0 17.67 14.33 32 32 32h384c17.67 0 32-14.33 32-32V64c0-17.67-14.33-32-32-32h-96l-7.2-14.31A32 32 0 0 0 276.8 0H171.2a32 32 0 0 0-36 17.69zM64 96h384v352H64V96zm32 32v288h64V128H96zm128 0v288h64V128h-64zm128 0v288h64V128h-64z"/></svg>';

            function showMsg(text, isError) {
                msgEl.textContent = text;
                msgEl.className = 'ext-ui-msg ' + (isError ? 'ext-ui-msg-error' : 'ext-ui-msg-success');
                msgEl.style.display = 'block';
                setTimeout(function() { msgEl.style.display = 'none'; }, 3000);
            }

            function buildFolderPath() {
                const map = {};
                items.forEach(function(it) { map[it.id] = it; });
                const path = [];
                let id = currentFolderId;
                while (id && id !== rootId) {
                    const it = map[id];
                    if (it) { path.unshift(it); id = it.folderId; } else break;
                }
                return path;
            }

            function renderBreadcrumb() {
                folderPath = buildFolderPath();
                if (folderPath.length === 0) {
                    breadcrumbEl.style.display = 'none';
                    return;
                }
                const parts = ['<span class="nav" data-id="' + rootId + '">' + t('documents') + '</span>'];
                folderPath.forEach(function(f) {
                    parts.push('<span class="nav" data-id="' + f.id + '">' + (f.name || '').replace(/</g, '&lt;') + '</span>');
                });
                const last = folderPath[folderPath.length - 1];
                parts[parts.length - 1] = '<span class="current">' + (last.name || '').replace(/</g, '&lt;') + '</span>';
                breadcrumbEl.innerHTML = parts.join(' &gt; ');
                breadcrumbEl.style.display = 'flex';
                breadcrumbEl.querySelectorAll('.nav').forEach(function(el) {
                    el.addEventListener('click', function() {
                        currentFolderId = parseInt(el.dataset.id, 10);
                        if (currentFolderId === rootId) currentFolderId = rootId;
                        render();
                    });
                });
            }

            function getCurrentItems() {
                var base = items.filter(function(it) {
                    const fid = it.folderId || rootId;
                    return fid === currentFolderId;
                });
                var q = (docSearchInput.value || '').trim().toLowerCase();
                if (!q) return base;
                return base.filter(function(it) { return (it.name || '').toLowerCase().indexOf(q) >= 0; });
            }

            function displayName(it) {
                var n = (it.nameKey && t(it.nameKey)) ? t(it.nameKey) : (it.name || '');
                return it.type === 'folder' ? n : n.replace(/\.[^.]+$/, '');
            }
            function renderItem(it, opts) {
                const isFolder = it.type === 'folder';
                const fullNameEsc = (it.name || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                const displayNameEsc = displayName(it).replace(/</g, '&lt;').replace(/"/g, '&quot;');
                let iconHtml;
                if (isFolder) {
                    iconHtml = '<span class="folder-icon">üìÅ</span>';
                } else if (it.thumbnailUrl) {
                    var thumbUrl = base() + it.thumbnailUrl;
                    iconHtml = '<img class="doc-thumb" src="' + thumbUrl + '" alt="" loading="lazy" />';
                } else {
                    iconHtml = '<span class="doc-icon">üìÑ</span>';
                }
                let actions = '';
                if (opts.visibilityToggle) {
                    var eyeTitle = it.visibleToPlayers ? t('visible_to_players') + ' (on)' : t('visible_to_players') + ' (off)';
                    actions += '<button type="button" class="ext-action-btn visibility-btn' + (it.visibleToPlayers ? ' on' : '') + '" data-id="' + it.id + '" title="' + eyeTitle + '">&#128065;</button>';
                }
                if (opts.rename) {
                    actions += '<button type="button" class="ext-action-btn rename-btn" data-id="' + it.id + '" title="' + t('rename') + '">' + pencilSvg + '</button>';
                }
                if (opts.move) {
                    actions += '<button type="button" class="ext-action-btn move-btn" data-id="' + it.id + '" title="' + t('move') + '">' + folderSvg + '</button>';
                }
                if (opts.delete) {
                    actions += '<button type="button" class="ext-action-btn delete del-btn" data-id="' + it.id + '" title="' + t('delete') + '">' + trashSvg + '</button>';
                }
                var contentClass = isFolder ? '' : ' doc-list-item-doc';
                return '<li class="ext-ui-list-item" data-id="' + it.id + '" data-type="' + (it.type || 'document') + '">' +
                    '<div class="ext-ui-list-item-content' + contentClass + '" data-id="' + it.id + '" data-hash="' + (it.fileHash || '') + '" data-name="' + fullNameEsc + '">' +
                    iconHtml + '<span class="ext-ui-list-item-name">' + displayNameEsc + '</span></div>' +
                    '<div class="ext-item-actions">' + actions + '</div></li>';
            }

            function render() {
                const current = getCurrentItems();
                const folders = current.filter(function(it) { return it.type === 'folder'; });
                const docs = current.filter(function(it) { return it.type === 'document'; });

                renderBreadcrumb();
                topBarEl.style.display = 'flex';
                var inSharedFolder = currentFolderId === -1;
                uploadBtn.style.display = inSharedFolder ? 'none' : '';
                newFolderBtn.style.display = inSharedFolder ? 'none' : '';

                if (current.length === 0) {
                    listEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    emptyEl.textContent = t('no_documents');
                } else {
                    emptyEl.style.display = 'none';
                    folders.sort(function(a, b) { return (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' }); });
                    docs.sort(function(a, b) { return (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' }); });
                    let html = '';
                    var canEdit = function(it) { return !it.shared; };
                    var visToggle = function(it) { return !!it.canToggleVisibility; };
                    folders.forEach(function(f) {
                        html += renderItem(f, { rename: canEdit(f), move: canEdit(f), delete: canEdit(f), visibilityToggle: visToggle(f) });
                    });
                    docs.forEach(function(d) {
                        html += renderItem(d, { rename: canEdit(d), move: canEdit(d), delete: canEdit(d), visibilityToggle: visToggle(d) });
                    });
                    listEl.innerHTML = html;
                    listEl.style.display = viewMode === 'grid' ? 'grid' : 'block';
                    listEl.classList.toggle('doc-grid', viewMode === 'grid');

                    listEl.querySelectorAll('.ext-ui-list-item-content').forEach(function(el) {
                        el.addEventListener('click', function(e) {
                            if (e.target.closest('.doc-actions')) return;
                            const type = el.closest('.ext-ui-list-item')?.dataset?.type;
                            const hash = el.dataset.hash;
                            const name = el.dataset.name || '';
                            if (type === 'folder') {
                                currentFolderId = parseInt(el.dataset.id, 10);
                                render();
                            } else if (hash) {
                                var target = (window.parent !== window) ? window.parent : (window.top && window.top.opener) || null;
                                if (target) {
                                    target.postMessage({
                                        type: 'planarally-open-document',
                                        fileHash: hash,
                                        name: name
                                    }, '*');
                                } else {
                                    var url = api('/api/extensions/documents/serve/' + hash) + '#toolbar=1&navpanes=1&scrollbar=1';
                                    window.open(url, '_blank');
                                }
                            }
                        });
                    });
                    listEl.querySelectorAll('.visibility-btn').forEach(function(el) {
                        el.addEventListener('click', async function(e) { e.stopPropagation(); await toggleVisibility(parseInt(el.dataset.id, 10)); });
                    });
                    listEl.querySelectorAll('.rename-btn').forEach(function(el) {
                        el.addEventListener('click', function(e) { e.stopPropagation(); renameItem(parseInt(el.dataset.id, 10)); });
                    });
                    listEl.querySelectorAll('.move-btn').forEach(function(el) {
                        el.addEventListener('click', async function(e) { e.stopPropagation(); await moveItem(parseInt(el.dataset.id, 10)); });
                    });
                    listEl.querySelectorAll('.del-btn').forEach(function(el) {
                        el.addEventListener('click', async function(e) { e.stopPropagation(); await deleteDoc(parseInt(el.dataset.id, 10)); });
                    });
                }
            }

            document.getElementById('viewListBtn').title = t('view_list');
            document.getElementById('viewGridBtn').title = t('view_grid');
            document.getElementById('viewListBtn').addEventListener('click', function() {
                viewMode = 'list';
                document.getElementById('viewListBtn').classList.add('active');
                document.getElementById('viewGridBtn').classList.remove('active');
                listEl.classList.remove('doc-grid');
                if (listEl.style.display !== 'none') listEl.style.display = 'block';
            });
            document.getElementById('viewGridBtn').addEventListener('click', function() {
                viewMode = 'grid';
                document.getElementById('viewGridBtn').classList.add('active');
                document.getElementById('viewListBtn').classList.remove('active');
                listEl.classList.add('doc-grid');
                if (listEl.style.display !== 'none') listEl.style.display = 'grid';
            });

            async function toggleVisibility(id) {
                var params = new URLSearchParams(window.location.search);
                var rc = params.get('room_creator');
                var rn = params.get('room_name');
                if (!rc || !rn) { showMsg(t('error_loading'), true); return; }
                try {
                    var r = await fetch(api('/api/extensions/documents/visibility'), {
                        method: 'PATCH',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: id, roomCreator: rc, roomName: rn })
                    });
                    if (r.ok) {
                        var data = await r.json();
                        var it = items.find(function(x) { return x.id === id; });
                        if (it) it.visibleToPlayers = data.visibleToPlayers;
                        showMsg(data.visibleToPlayers ? t('visible_to_players') + ' ON' : t('visible_to_players') + ' OFF');
                        render();
                    } else {
                        showMsg(await r.text() || t('failed'), true);
                    }
                } catch (e) {
                    showMsg(t('failed'), true);
                }
            }

            async function renameItem(id) {
                const it = items.find(function(x) { return x.id === id; });
                if (!it) return;
                const name = typeof parentPrompt === 'function' ? await parentPrompt(t('new_name'), t('rename'), it.name || '') : prompt(t('new_name'), it.name || '');
                if (name == null || !name.trim()) return;
                fetch(api('/api/extensions/documents/rename'), {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, name: name.trim() })
                }).then(function(r) {
                    if (r.ok) { showMsg(t('renamed')); load(); }
                    else r.text().then(function(res) { showMsg(res || t('rename_failed'), true); });
                }).catch(function() { showMsg(t('rename_failed'), true); });
            }

            function getDescendantIds(folderId) {
                const ids = [folderId];
                items.filter(function(x) { return (x.folderId || rootId) === folderId; }).forEach(function(x) {
                    if (x.type === 'folder') ids.push.apply(ids, getDescendantIds(x.id));
                });
                return ids;
            }

            async function moveItem(id) {
                const it = items.find(function(x) { return x.id === id; });
                if (!it) return;
                const excludeIds = it.type === 'folder' ? getDescendantIds(id) : [id];
                const folders = items.filter(function(x) {
                    return x.type === 'folder' && excludeIds.indexOf(x.id) < 0;
                });
                const destIds = [{ id: rootId, name: t('documents_root') }];
                folders.forEach(function(f) { destIds.push({ id: f.id, name: f.name }); });
                const choice = destIds.map(function(d, i) { return (i + 1) + '. ' + d.name; }).join('\n');
                const num = typeof parentPrompt === 'function' ? await parentPrompt(t('move_to_folder') + '\n\n' + choice, t('move'), '1') : prompt(t('move_to_folder') + '\n\n' + choice);
                if (num == null || num === '') return;
                const idx = parseInt(num, 10);
                if (isNaN(idx) || idx < 1 || idx > destIds.length) return;
                const destId = destIds[idx - 1].id;
                if (destId === (it.folderId || rootId)) return;
                fetch(api('/api/extensions/documents/move'), {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, parentId: destId })
                }).then(function(r) {
                    if (r.ok) { showMsg(t('moved')); load(); }
                    else r.text().then(function(res) { showMsg(res || t('move_failed'), true); });
                }).catch(function() { showMsg(t('move_failed'), true); });
            }

            async function load() {
                loadingEl.style.display = 'block';
                emptyEl.style.display = 'none';
                listEl.style.display = 'none';
                breadcrumbEl.style.display = 'none';
                topBarEl.style.display = 'none';
                try {
                    var listUrl = api('/api/extensions/documents/list');
                    var params = new URLSearchParams(window.location.search);
                    var rc = params.get('room_creator');
                    var rn = params.get('room_name');
                    if (rc && rn) {
                        listUrl += '?room_creator=' + encodeURIComponent(rc) + '&room_name=' + encodeURIComponent(rn);
                    }
                    const r = await fetch(listUrl, { credentials: 'include' });
                    const data = r.ok ? await r.json() : { documents: [], rootId: null };
                    items = data.documents || [];
                    rootId = data.rootId;
                    if (currentFolderId === null || !items.some(function(it) { return it.id === currentFolderId || (it.type === 'folder' && it.folderId === currentFolderId); })) {
                        currentFolderId = rootId;
                    }
                    loadingEl.style.display = 'none';
                    render();
                    var missingThumbs = items.filter(function(it) { return it.type === 'document' && it.fileHash && !it.thumbnailUrl; }).map(function(it) { return it.fileHash; });
                    if (missingThumbs.length > 0) {
                        try {
                            var genR = await fetch(api('/api/extensions/documents/generate-thumbnails'), {
                                method: 'POST',
                                credentials: 'include',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ fileHashes: missingThumbs })
                            });
                            if (genR.ok) {
                                var genData = await genR.json();
                                if (genData.generated > 0) { load(); }
                            }
                        } catch (e) { /* ignore */ }
                    }
                } catch (e) {
                    loadingEl.style.display = 'none';
                    emptyEl.textContent = t('error_loading');
                    emptyEl.style.display = 'block';
                }
            }

            async function deleteDoc(id) {
                const it = items.find(function(x) { return x.id === id; });
                if (!it) return;
                const ok = typeof parentConfirm === 'function' ? await parentConfirm(t('delete'), t('delete_confirm', { name: it.name || '' })) : confirm(t('delete_confirm', { name: it.name || '' }));
                if (!ok) return;
                try {
                    const r = await fetch(api('/api/extensions/documents/delete'), {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: id })
                    });
                    if (r.ok) {
                        showMsg(t('deleted'));
                        load();
                    } else {
                        showMsg(await r.text() || t('delete_failed'), true);
                    }
                } catch (e) {
                    showMsg(t('delete_failed'), true);
                }
            }

            newFolderBtn.addEventListener('click', async function() {
                const name = typeof parentPrompt === 'function' ? await parentPrompt(t('folder_name'), t('new_folder'), '') : prompt(t('folder_name'));
                if (!name || !name.trim()) return;
                fetch(api('/api/extensions/documents/folder'), {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name.trim(), parentId: currentFolderId })
                }).then(function(r) {
                    if (r.ok) { showMsg(t('folder_created')); load(); }
                    else r.text().then(function(res) { showMsg(res || t('failed'), true); });
                }).catch(function() { showMsg(t('failed'), true); });
            });

            fileInput.addEventListener('change', async function() {
                const files = fileInput.files;
                if (!files || files.length === 0) return;
                const pdfs = Array.prototype.filter.call(files, function(f) { return f.name.toLowerCase().endsWith('.pdf'); });
                if (pdfs.length === 0) return;
                uploadBtn.disabled = true;
                var okCount = 0;
                var errCount = 0;
                try {
                    for (var i = 0; i < pdfs.length; i++) {
                        var file = pdfs[i];
                        var fd = new FormData();
                        fd.append('file', file);
                        if (rootId) {
                            fd.append('parentId', String(currentFolderId || rootId));
                        }
                        var r = await fetch(api('/api/extensions/documents/upload'), {
                            method: 'POST',
                            credentials: 'include',
                            body: fd
                        });
                        if (r.ok) {
                            okCount++;
                        } else {
                            errCount++;
                        }
                    }
                    if (okCount > 0) {
                        showMsg(okCount === 1 ? t('document_uploaded') : (okCount + ' ' + t('documents_uploaded_count')));
                        load();
                    }
                    if (errCount > 0) {
                        showMsg((errCount === pdfs.length ? '' : okCount + ' ok. ') + t('upload_failed'), true);
                    }
                } catch (e) {
                    showMsg(t('upload_failed'), true);
                } finally {
                    uploadBtn.disabled = false;
                    fileInput.value = '';
                }
            });

            uploadBtn.addEventListener('click', function() { fileInput.click(); });
            docSearchInput.addEventListener('input', function() { render(); });

            load();
        })();
    </script>
</body>
</html>
