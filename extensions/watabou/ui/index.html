<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watabou Generators</title>
    <link rel="stylesheet" href="../../../../static/extensions/ui.css?v=2" />
    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: system-ui, sans-serif;
            font-size: 14px;
        }

        .wb-root {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .wb-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
            flex-shrink: 0;
        }

        .wb-back-btn,
        .wb-regen-btn,
        .wb-export-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .wb-back-btn:hover,
        .wb-regen-btn:hover,
        .wb-export-btn:hover {
            background: #eee;
        }

        .wb-export-group {
            display: flex;
            gap: 0.35rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .wb-import-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #5c6bc0;
            border-radius: 6px;
            background: #5c6bc0;
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: background 0.2s;
        }

        .wb-import-btn:hover {
            background: #4a59a7;
        }

        .wb-permalink-wrap {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            flex: 1;
            min-width: 0;
            max-width: 400px;
        }

        .wb-permalink-input {
            flex: 1;
            min-width: 120px;
            padding: 0.35rem 0.5rem;
            font-size: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .wb-permalink-input::placeholder {
            color: #999;
        }

        .wb-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 1rem 1.5rem;
        }

        .wb-iframe-wrap {
            flex: 1;
            min-height: 0;
            display: none;
            position: relative;
        }

        .wb-iframe-wrap.active {
            display: flex;
            flex-direction: column;
        }

        .wb-iframe-wrap iframe {
            flex: 1;
            width: 100%;
            border: none;
            min-height: 400px;
        }

        .wb-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .wb-card {
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 12px;
            background: #fff;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            text-decoration: none;
            color: inherit;
            overflow: hidden;
        }

        .wb-card:hover {
            border-color: #5c6bc0;
            box-shadow: 0 8px 24px rgba(92, 107, 192, 0.2);
            transform: translateY(-4px);
        }

        .wb-card-img {
            width: 100%;
            height: 160px;
            background-size: cover;
            background-position: center;
            border-bottom: 1px solid #eee;
        }

        .wb-card-body {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .wb-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .wb-card-desc {
            font-size: 0.85rem;
            line-height: 1.4;
            color: #666;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Modal & Dropzone */
        .wb-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .wb-modal-overlay.active {
            display: flex;
        }

        .wb-modal {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .wb-modal-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wb-modal-close {
            cursor: pointer;
            font-size: 1.5rem;
            color: #999;
        }

        .wb-modal-close:hover {
            color: #333;
        }

        .wb-modal-body {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #444;
            margin-bottom: 1.5rem;
        }

        .wb-dropzone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #fdfdfd;
            transition: border-color 0.2s, background 0.2s;
            cursor: pointer;
            position: relative;
        }

        .wb-dropzone.dragover {
            border-color: #5c6bc0;
            background: #f0f2ff;
        }

        .wb-dropzone input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .wb-dropzone-icon {
            font-size: 2rem;
            color: #999;
            margin-bottom: 0.5rem;
        }

        .wb-dropzone-text {
            color: #666;
            font-weight: 500;
        }

        .wb-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 0.5rem;
            border-radius: 8px;
        }

        .wb-loading-overlay.active {
            display: flex;
        }

        .wb-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #eee;
            border-top: 3px solid #5c6bc0;
            border-radius: 50%;
            animation: wb-spin 1s linear infinite;
        }

        @keyframes wb-spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="ext-ui-root">
    <div class="wb-root ext-modal-body-wrapper">
        <div id="toolbar" class="wb-toolbar" style="display: none;">
            <button type="button" id="backBtn" class="wb-back-btn">‚Üê Back</button>
            <div class="wb-export-group">
                <button type="button" id="importMapBtn" class="wb-import-btn">Importa mappa</button>
                <button type="button" id="regenBtn" class="wb-regen-btn"></button>
            </div>
        </div>
        <div id="listView" class="wb-content">
            <div class="wb-list" id="generatorList"></div>
        </div>
        <div id="iframeView" class="wb-iframe-wrap">
            <iframe id="generatorFrame" title="Watabou Generator"></iframe>
        </div>
        <div id="importModal" class="wb-modal-overlay">
            <div class="wb-modal">
                <div class="wb-modal-header">
                    <span id="importModalTitle">Importa Mappa</span>
                    <span class="wb-modal-close" id="closeImportModal">&times;</span>
                </div>
                <div class="wb-modal-body" id="importModalBody">
                    Per importare la mappa in PlanarAlly torna indietro premi il tasto destro e clicca su Export -> as
                    PNG dopo averlo scaricato trascinalo qui:
                </div>
                <div class="wb-dropzone" id="dropzone">
                    <div class="wb-dropzone-icon">üìÅ</div>
                    <div class="wb-dropzone-text" id="dropzoneText">Trascina qui il file o clicca per selezionarlo</div>
                    <input type="file" id="fileInput" accept="image/png,image/jpeg" />
                    <div class="wb-loading-overlay" id="loadingOverlay">
                        <div class="wb-spinner"></div>
                        <span id="loadingText">Caricamento...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        (function () {
            var GENERATORS = [
                { url: "https://watabou.github.io/perilous-shores", name: "Region Generator", nameKey: "region", img: "card_realm.jpg", descKey: "regionDesc" },
                { url: "https://watabou.github.io/city-generator", name: "City Generator", nameKey: "city", img: "card_city.jpg", descKey: "cityDesc" },
                { url: "https://watabou.github.io/village-generator/", name: "Village Generator", nameKey: "village", img: "card_village.jpg", descKey: "villageDesc" },
                { url: "https://watabou.github.io/cave-generator", name: "Cave/Glade Generator", nameKey: "cave", img: "card_cave.jpg", descKey: "caveDesc" },
                { url: "https://watabou.github.io/one-page-dungeon", name: "Dungeon Generator", nameKey: "dungeon", img: "card_dungeon.jpg", descKey: "dungeonDesc" },
                { url: "https://watabou.github.io/dwellings/", name: "Dwellings Building Generator", nameKey: "dwellings", img: "card_dwelling.jpg", descKey: "dwellingsDesc" }
            ];

            var TRANSLATIONS = {
                en: {
                    back: "Back", regen: "Random", import: "Add to Map", region: "Region Generator", city: "City Generator", village: "Village Generator", cave: "Cave/Glade Generator", dungeon: "Dungeon Generator", dwellings: "Dwellings Building Generator",
                    importMap: "Import Map", importTitle: "Import Map to PlanarAlly", importInstructions: "To import the map into PlanarAlly, go back, right-click and click on Export -> as PNG. Once downloaded, drag it here:",
                    dropzoneText: "Drag file here or click to select", loading: "Uploading...", uploadSuccess: "Import successful", uploadError: "Upload failed",
                    regionDesc: "Perilous Shores is a fantasy region generator with the scale of resulting maps ranging from an area around a single town to a small continent. While the maps are built on a hexagonal grid, the generator tries to be subtle about that underlying geometry. It was designed to produce hand-drawn looking maps, but now it is capable of displaying them in a variety of styles.",
                    cityDesc: "Medieval Fantasy City Generator (MFCG) is the most developed and most popular generator of this set. Its initial version was crteated for the Montly Challenge on Reddit and back then maps it produced weren't much more than city-shaped Voronoi diagrams. Todays MFCG is capable of generating much more detailed and realistic maps with a lot of customization options.",
                    villageDesc: "Unlike cities in the city generator, villages in the Village Generator are made of roads, not buildings. Houses are placed sparsely along these winding roads and complemented by fields and lots of trees to make resulting maps look rural.",
                    caveDesc: "Cave/Glade generator was designed as an analogue of 1PDG for such natural locations as caves and burrows. However, later I realized that by changing the way maps are drawn, the same maps could be used to portray groups of connected clearings i.e. small passable areas of dense woods.",
                    dungeonDesc: "One Page Dungeon Generator is inspired by the contest of the same name. The idea is not only to generate a meaningful dungeon plan, but also provide short descriptions for some of its locations. This is supposed to induce the feeling of the place having a story, even if a very vague one.",
                    dwellingsDesc: "Dwellings is a generator of residential buildings ranging from simple cabins to mansions and small castles. Unlike its predicessor Procgen Mansion, the focus here is on meaningful floor plans (not exteriors) with most rooms assigned a specific purpose e.g. kitchen, armoury etc. The resulting floor plans are accompanied by elevation views of the building."
                },
                it: {
                    back: "Indietro", regen: "Casuale", import: "Aggiungi alla Mappa", region: "Generatore Regioni", city: "Generatore Citt√†", village: "Generatore Villaggi", cave: "Generatore Caverne", dungeon: "Generatore Dungeon", dwellings: "Generatore Edifici",
                    importMap: "Importa mappa", importTitle: "Importa la mappa in PlanarAlly", importInstructions: "Per importare la mappa in PlanarAlly torna indietro premi il tasto destro e clicca su Export -> as PNG dopo averlo scaricato trascinalo qui:",
                    dropzoneText: "Trascina qui il file o clicca per selezionarlo", loading: "Caricamento...", uploadSuccess: "Importazione completata", uploadError: "Caricamento fallito",
                    regionDesc: "Perilous Shores √® un generatore di regioni fantasy con mappe che variano da un'area intorno a una singola citt√† a un piccolo continente. Sebbene le mappe siano costruite su una griglia esagonale, il generatore cerca di essere sottile riguardo a tale geometria sottostante. √à stato progettato per produrre mappe dall'aspetto disegnato a mano, ma ora √® in grado di visualizzarle in una variet√† di stili.",
                    cityDesc: "Medieval Fantasy City Generator (MFCG) √® il generatore pi√π sviluppato e popolare di questo set. La sua versione iniziale √® stata creata per la sfida mensile su Reddit e all'epoca le mappe prodotte non erano molto pi√π di diagrammi di Voronoi a forma di citt√†. L'attuale MFCG √® in grado di generare mappe molto pi√π dettagliate e realistiche con molte opzioni di personalizzazione.",
                    villageDesc: "A differenza delle citt√† nel generatore di citt√†, i villaggi nel Village Generator sono fatti di strade, non di edifici. Le case sono posizionate in modo sparso lungo queste strade tortuose e completate da campi e molti alberi per far sembrare le mappe rurali.",
                    caveDesc: "Il generatore di caverne/radure √® stato progettato come un analogo di 1PDG per luoghi naturali come caverne e tane. Tuttavia, in seguito mi sono reso conto che cambiandone la rappresentazione, le stesse mappe potrebbero essere utilizzate per ritrarre gruppi di radure collegate, ovvero piccole aree percorribili di fitti boschi.",
                    dungeonDesc: "One Page Dungeon Generator √® ispirato al concorso omonimo. L'idea non √® solo quella di generare una planimetria significativa per un dungeon, ma anche di fornire brevi descrizioni per alcune delle sue posizioni. Questo dovrebbe indurre la sensazione che il luogo abbia una storia, anche se molto vaga.",
                    dwellingsDesc: "Dwellings √® un generatore di edifici residenziali che spaziano da semplici capanne a palazzi e piccoli castelli. A differenza del suo predecessore Procgen Mansion, qui l'attenzione √® rivolta a planimetrie significative (non agli esterni) con la maggior parte delle stanze assegnate a uno scopo specifico, ad esempio cucina, armeria, ecc. Le planimetrie risultanti sono accompagnate da viste prospettiche dell'edificio."
                },
                de: { back: "Zur√ºck", regen: "Zuf√§llig", import: "Zur Karte hinzuf√ºgen", region: "Region Generator", city: "City Generator", village: "Village Generator", cave: "Cave/Glade Generator", dungeon: "Dungeon Generator", dwellings: "Dwellings Building Generator" },
                fr: { back: "Retour", regen: "Al√©atoire", import: "Ajouter alla carte", region: "Region Generator", city: "City Generator", village: "Village Generator", cave: "Cave/Glade Generator", dungeon: "Dungeon Generator", dwellings: "Dwellings Building Generator" },
                es: { back: "Volver", regen: "Aleatorio", import: "A√±adir al Mapa", region: "Region Generator", city: "City Generator", village: "Village Generator", cave: "Cave/Glade Generator", dungeon: "Dungeon Generator", dwellings: "Dwellings Building Generator" }
            };

            function getLocale() {
                var params = new URLSearchParams(window.location.search);
                var loc = (params.get("locale") || "en").slice(0, 2);
                return TRANSLATIONS[loc] ? loc : "en";
            }

            var locale = getLocale();
            var L = TRANSLATIONS[locale] || TRANSLATIONS.en;

            function t(key) {
                return L[key] || TRANSLATIONS.en[key] || key;
            }

            function api(path) {
                var base = window.location.pathname.indexOf('/api/') >= 0 ? window.location.pathname.slice(0, window.location.pathname.indexOf('/api/')) : '';
                return base + path;
            }

            var listEl = document.getElementById("generatorList");
            var currentGeneratorUrl = "";

            var importModal = document.getElementById("importModal");
            var closeImportModal = document.getElementById("closeImportModal");
            var importMapBtn = document.getElementById("importMapBtn");
            var dropzone = document.getElementById("dropzone");
            var fileInput = document.getElementById("fileInput");
            var loadingOverlay = document.getElementById("loadingOverlay");
            var currentGeneratorName = "Generic";
            // Added missing element references for proper functionality
            var toolbar = document.getElementById("toolbar");
            var listView = document.getElementById("listView");
            var iframeView = document.getElementById("iframeView");
            var frame = document.getElementById("generatorFrame");

            function renderList() {
                listEl.innerHTML = GENERATORS.map(function (g) {
                    var name = t(g.nameKey);
                    var desc = t(g.descKey);
                    var imgUrl = 'images/' + g.img;
                    return '<a class="wb-card" href="#" data-url="' + g.url.replace(/"/g, "&quot;") + '" data-name="' + g.name.replace(/"/g, "&quot;") + '">' +
                        '<div class="wb-card-img" style="background-image: url(' + imgUrl + ')"></div>' +
                        '<div class="wb-card-body">' +
                        '<span class="wb-card-title">' + name.replace(/</g, "&lt;") + '</span>' +
                        '<span class="wb-card-desc">' + desc.replace(/</g, "&lt;") + '</span>' +
                        '</div>' +
                        '</a>';
                }).join("");

                listEl.querySelectorAll(".wb-card").forEach(function (el) {
                    el.addEventListener("click", function (e) {
                        e.preventDefault();
                        currentGeneratorName = el.dataset.name;
                        openGenerator(el.dataset.url, el.dataset.name);
                    });
                });
            }

            function openGenerator(url, name) {
                currentGeneratorUrl = url;
                frame.src = url;
                listView.style.display = "none";
                iframeView.classList.add("active");
                toolbar.style.display = "flex";
            }

            function regenerate() {
                if (!currentGeneratorUrl) return;
                var sep = currentGeneratorUrl.indexOf("?") >= 0 ? "&" : "?";
                frame.src = currentGeneratorUrl + sep + "_=" + Date.now();
            }

            function showList() {
                frame.src = "about:blank";
                iframeView.classList.remove("active");
                listView.style.display = "block";
                toolbar.style.display = "none";
            }

            function toggleImportModal(show) {
                importModal.classList.toggle("active", show);
            }

            async function handleFileUpload(file) {
                if (!file) return;
                loadingOverlay.classList.add("active");
                var formData = new FormData();
                formData.append("file", file);
                formData.append("generator", currentGeneratorName);

                try {
                    var response = await fetch(api("/api/extensions/watabou/upload"), {
                        method: "POST",
                        body: formData
                    });

                    if (response.ok) {
                        var data = await response.json();
                        window.parent.postMessage({
                            type: "planarally-add-to-map",
                            url: data.url,
                            gridCells: data.gridCells
                        }, "*");
                        toggleImportModal(false);
                        window.parent.postMessage({ type: "planarally-toast", message: t("uploadSuccess") }, "*");
                    } else {
                        var err = await response.text();
                        window.parent.postMessage({ type: "planarally-toast", message: t("uploadError") + ": " + err, error: true }, "*");
                    }
                } catch (e) {
                    window.parent.postMessage({ type: "planarally-toast", message: t("uploadError"), error: true }, "*");
                } finally {
                    loadingOverlay.classList.remove("active");
                    fileInput.value = "";
                }
            }

            importMapBtn.addEventListener("click", function () { toggleImportModal(true); });
            closeImportModal.addEventListener("click", function () { toggleImportModal(false); });
            importModal.addEventListener("click", function (e) { if (e.target === importModal) toggleImportModal(false); });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => dropzone.classList.add("dragover"), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => dropzone.classList.remove("dragover"), false);
            });

            dropzone.addEventListener("drop", function (e) {
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener("change", function () {
                if (fileInput.files && fileInput.files.length > 0) {
                    handleFileUpload(fileInput.files[0]);
                }
            });

            backBtn.addEventListener("click", showList);
            backBtn.textContent = t("back");
            regenBtn.textContent = t("regen");
            regenBtn.addEventListener("click", regenerate);

            // Set translated strings
            importMapBtn.textContent = t("importMap");
            document.getElementById("importModalTitle").textContent = t("importTitle");
            document.getElementById("importModalBody").textContent = t("importInstructions");
            document.getElementById("dropzoneText").textContent = t("dropzoneText");
            document.getElementById("loadingText").textContent = t("loading");

            renderList();
        })();
    </script>
</body>

</html>